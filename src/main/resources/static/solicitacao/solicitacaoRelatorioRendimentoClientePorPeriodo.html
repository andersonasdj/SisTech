<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="shortcut icon" href="../assets/img/favicon.ico">
	<link rel="stylesheet" href="../assets/css/defaultStyle.css">
	<link rel="stylesheet" href="../assets/css/styleBusca.css">
	<link rel="stylesheet" href="../assets/css/bootstrap.min.css">
	<link rel="stylesheet" href="../assets/css/StyleSolicitacao.css">
	<link rel="stylesheet" href="../assets/css/styleDashBoardCliente.css">
	<link rel="stylesheet" href="../assets/css/password-generator.css">
	<link rel="stylesheet" href="../assets/css/StyleSolicitacaoFinalizada.css">
	<link rel="stylesheet" href="../assets/css/bootstrap-icons.min.css">
	<link rel="stylesheet" href="../assets/css/dark.css">
	<title>Sistech - Solicitações</title>
</head>
<body>
	<div class="container-fluid">
		<!-- ###################################### BARRA DE NAVEGAÇÃO ###################################### -->
		<nav class="navbar navbar-expand-lg bg-light">
			<div class="container-fluid">
				<a class="navbar-brand" href="/sistech/home"><img src="../assets/img/key.png" style="height: 18px;"> SisTech</a>
				<button class="navbar-toggler" type="button" data-bs-toggle="collapse"
					data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"> </span>
				</button>
				<div class="collapse navbar-collapse" id="navbarSupportedContent">
					<ul class="navbar-nav me-auto mb-2 mb-lg-0">
						<li class="nav-item"><a class="nav-link active" aria-current="page" href="/sistech/home">Início</a></li>
							<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Solicitações</a>
							<ul class="dropdown-menu">
								<li><a class="dropdown-item" href="/sistech/solicitacao/form">Novo</a></li>
								<li><a class="dropdown-item" href="/sistech/solicitacao/list">Listar</a></li>
								<li><hr class="dropdown-divider"></li>
								<li><a class="dropdown-item" href="/sistech/solicitacao/modelos">Modelos</a></li>	
								<li><hr class="dropdown-divider"></li>
								<li><a class="dropdown-item" href="/sistech/solicitacao/relatorios">Relatórios</a></li>
							</ul>
						</li>
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Clientes</a>
							<ul class="dropdown-menu">
								<li><a class="dropdown-item" href="/sistech/cliente/list">Listar</a></li>
								<li><a class="dropdown-item" href="/sistech/cliente/form">Novo</a></li>
							</ul>
						</li>
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Funcionarios</a>
							<ul class="dropdown-menu">
								<li><a class="dropdown-item" href="/sistech/funcionario/list">Listar</a></li>
								<li><a class="dropdown-item" href="/sistech/funcionario/form">Novo</a></li>
							</ul>
						</li>
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Dashboard</a>
							<ul class="dropdown-menu">
								<li><a class="dropdown-item" href="/dashboard/inicio" target="_blank" style="color: brown; font-weight: bold;">Realtime <i class="bi bi-speedometer2"></i></a></li>
								<li><a class="dropdown-item" href="/sistech/solicitacao/dashboard/geral">Solicitações ativas</a></li>
								<li><a class="dropdown-item" href="/sistech/solicitacao/dashboard/funcionario">Funcionario</a></li>
								<li><a class="dropdown-item" href="/sistech/solicitacao/dashboard/cliente">Cliente</a></li>
							</ul>
						</li>
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Ferramentas</a>
							<ul class="dropdown-menu">
								<li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalPasswordGenerator">Password Generator</a></li>
								<li><a class="dropdown-item" href="/sistech/avisos">Avisos</a></li>
								<li><a class="dropdown-item" href="/sistech/calendario">Calendário</a></li>
							</ul>
						</li>
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle color-text" href="#" role="button" data-bs-toggle="dropdown"aria-expanded="false">Computadores</a>
							<ul class="dropdown-menu">
								<li><a class="dropdown-item" href="/sistech/computador/list">Listar</a></li>
							</ul>
						</li>
					</ul>
					<span class="nav-item">
						  <button class="btn btn-sm btn-outline-secondary" onclick="toggleDarkMode()" id="toggleDarkBtn">
						    <i class="bi bi-moon"></i> Modo Escuro
						  </button>
						</span>
						&nbsp; &nbsp; &nbsp; &nbsp;
					<ul class="navbar-nav mb-3 mb-lg-0">
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" id="perfil" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"></a>
							<ul class="dropdown-menu">
								<li><a class="dropdown-item" href="/sistech/funcionario/perfil">Perfil</a></li>
								<li><hr class="dropdown-divider"></li>
								<li><a class="dropdown-item" href="/sistech/gerencia">Gerência</a></li>
								<li><a class="dropdown-item" href="/sistech/configuracoes">Configurações</a></li><li>
								<li><hr class="dropdown-divider"></li>
								<li><a class="dropdown-item" href="/sistech/sobre">Sobre</a></li>
							</ul>
						</li>
							<a href="/sistech/logout"><i class="bi bi-power"style="font-size: 2rem; color: red;"> </i></a>
					</ul>
				</div>
			</div>
		</nav>
		<!-- ###################################### BARRA DE NAVEGAÇÃO ###################################### -->

		<hr class="bg-danger border-2 border-top border-danger">
		<div class="container-fluid borda-pontilhada">
				<div class="row">				
					<div class="col-md-3">
						<div class="control-group">
							<label class="form-label mt-4 fonteModal"><b>Data Inicio *</b></label>
							<div class="calendarioAberturaModal">
								<input type="date" id="dataInicio" name="dataAberturaModalEdicao" >
								<span> </span>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="control-group">
							<label class="form-label mt-4 fonteModal"><b>Data Fim *</b></label>
							<div class="calendarioAndamentoModal">
								<input type="date" id="dataFim" name="dataAndamentoModalEdicao" value="">
								<span> </span>
							</div>
						</div>
					</div>
					
					<div class="col-md-3 mt-2">
						<div class="control-group mt-3">
							<span id="diasUteis" class="me-3 fw-semibold"></span>
				            <span id="custoTotalOperacional" class="me-3 fw-semibold text-muted"></span>
				            <span id="custoTotalTempo" class="fw-semibold text-muted"></span>
						</div>
					</div>
				</div>
				<br />
				<div class="row">				
					<div class="col-md-2">
						<button class="btn btn-secondary btn-sm mt-2" onclick="preencheHoje()">Hoje</button>
						<button class="btn btn-secondary btn-sm mt-2" onclick="preencheDias(7)">7 dias</button>
						<button class="btn btn-secondary btn-sm mt-2" onclick="preencheDias(15)">15 dias</button>
						<button class="btn btn-secondary btn-sm mt-2" onclick="preencheDias(30)">30 dias</button>
					</div>
				</div>
				<div class="row">				
					<div class="col-md-1">
						<button class="btn btn-primary btn-sm mt-3" onclick="listarRendimentos()">listar</button>
					</div>
				</div>
				<br />
		</div>
		
		<div id="conteudo" style="display: none;">
			<br />
			<div class="table-responsive">
				<table  class="table table-hover table-striped table-bordered align-middle results sortable table-action" id="tabela-rendimentos" style="text-align: center;">
					<thead>
						<tr class="table-primary">
							<th scope="col">Cliente</th>
							<th scope="col">Abertos no Período</th>
							<th scope="col">Atualizados no Período</th>
							<th scope="col">Finalizados no Período</th>
							<th scope="col">Média Hora / dia</th>
							<th scope="col">Franquia</th>
							<th scope="col">Consumo da Franquia</th>
							<th scope="col">Custo Operacional</th>
							<th scope="col"></th>
						</tr>
					</thead>
					<tbody id="corpoRendimentos">
						<tr> </tr>
					</tbody>
				</table>
				
			</div>
		</div>
		
		<div id="conteudoGrafico" style="display: none;">
			<hr class="bg-danger border-2 border-top border-danger">
			<div class="container-fluid">
				<div class="row justify-content-between">
					<div class="col-4 col-s-8" id="graficoTempo">
						<h5 style="text-align: center;" class="mt-3">Duração (minutos)</h5>
						<canvas id="minutosSolicitacoes" style="height:35vh; width:30vw"> </canvas>
					</div>
					<div class="col-7 col-s-8" id="graficoClientes">
						<h5 style="text-align: center;" class="mt-3">Finalizadas por Cliente</h5>
						<canvas id="clientesSolicitacoes" style="height:35vh; width:30vw"> </canvas>
					</div>
					
					<div class="col-2"> </div>
				</div>
				<br />
			</div>
		</div>

		<br />
		<footer class="container-fluid fixed-bottom text-center text-white">
				<div class="text-center" style="background-color: rgba(0, 0, 0, 0.2);">
					2025 Copyright:
					<a class="text-white" href="#">Techgold</a>
				</div>
		</footer>
		
	</div>
	<script src="../assets/js/jquery-3.6.3.js"></script>
	<script src="../assets/js/popper.min.js"></script>
	<script src="../assets/js/bootstrap.min.js"></script>
	<script src="../assets/js/sorttable.js"></script>
	<script src="../assets/js/chart.js"></script>
	<script src="../assets/js/dark.js"></script>
	<script>
		
		function printRelatorio(id) {
			var inicio = $('#dataInicio').val();
			var fim = $('#dataFim').val();
			var cliente = $('#cliente'+id).text();
			var franquia = $('#franquia'+id).text();
			var size = $('#qtdFinalizados'+id).text();
			
			window.open('../impressao-timesheet-cliente?id='+id+'&inicio='+inicio+'&fim='+fim+'&nome='+cliente+'&franquia='+franquia+'&size='+size, '_blank');
      	}
		
		
		function listarRendimentos(){
			var inicio = $('#dataInicio').val();
			var fim = $('#dataFim').val();
			
			$('#corpoRendimentos').empty();
			
			
			var data_inicial  = new Date(inicio);
			var data_final = new Date(fim);
			
			var resultados = [];
			var data_inicio = data_inicial;
			var final_semana = [5,6];
			while (data_inicio <= data_final) {
			 	var data = new Date(data_inicio);
			 	if (!final_semana.includes(data.getDay())){
			 		var data_formatada = data.toISOString().slice(0,10);
			 		resultados.push(data_formatada);
				}
			    	data_inicio.setUTCDate(data_inicio.getUTCDate() + 1);
			}
			
			if(inicio != "" && fim != ""){	
				document.getElementById('conteudo').style.display = 'none';
				document.getElementById('conteudoGrafico').style.display = 'none';
				$.ajax({
					type: "GET",
					contentType: "application/json",
					url: "/sistech/solicitacao/relatorio/rendimento/cliente/inicio/"+inicio+"/fim/"+fim,
										
					success: function (data) {
						$("#conteudo").stop().slideToggle(600);$("#conteudoGrafico").stop().slideToggle(1000);
						$('#diasUteis').empty();
						$('#custoTotalOperacional').empty();
						$('#custoTotalTempo').empty();
						$('#diasUteis').append('<li> Dias úteis: <b>'+resultados.length+'</b></li>');
						$('#custoTotalOperacional').append('<li> Custo Total Operacional: <b>'+formatarMoedaBR(data.custoOperacionalTotal)+'</b></li>');
						$('#custoTotalTempo').append('<li> Custo Total Tempo: <b>'+minutosParaHorasTexto(data.tempoTotalMinutos)+'</b></li>');
						
						data.clientes.forEach(i =>{
							var horas, tempoContratado, alerta;
							if(i.qtdHoras != null){
								horas = minutosParaHorasTexto(i.qtdHoras);
							}else{
								horas = 0;
							}
							if(i.tempoContratado != null){
								tempoContratado = minutosParaHorasTexto(i.tempoContratado);
							}else{
								tempoContratado = 0;
							}
							
							if(i.qtdHoras > i.tempoContratado){
								alerta = 'style="color: red"';
							}else if(i.qtdHoras > (i.tempoContratado /2) && i.qtdHoras < i.tempoContratado) {
								alerta = 'style="color: #d97b02"';
							}
							else{
								alerta = 'style="color: green"';
							}

							$('#horaDia').empty();
							
							var itens = 
							
								'<tr>'
								+ '<td id=cliente'+i.clienteId+'>' + i.nomeCliente + '</td>'
								+ '<td data-sort-value="'+i.qtdAbertos+'">' + i.qtdAbertos + '</td>'
								+ '<td data-sort-value="'+i.qtdAtualizados+'">' + i.qtdAtualizados + '</td>'
								+ '<td id=qtdFinalizados'+i.clienteId+' data-sort-value="'+i.qtdFinalizados+'">' + i.qtdFinalizados + '</td>'
								+ '<td data-sort-value="'+(i.qtdHoras/resultados.length).toFixed(0)+'">'+minutosParaHorasTexto((i.qtdHoras/resultados.length).toFixed(0)) + '</td>'
								+ '<td id=franquia'+i.clienteId+'>' + tempoContratado + '</td>'
								+ '<td '+alerta+' data-sort-value="'+i.qtdHoras+'"><b>' + horas + '</b></td>'
								+ '<td data-sort-value="'+i.custoOperacional+'"><b>'+ formatarMoedaBR(i.custoOperacional) + '</b></td>'
								+ '<td> <a href="#" onclick=printRelatorio('+i.clienteId+')><i style="font-size: 25px" class="bi bi-printer"></i></a></td>'
								+ '</tr>'
								$('#corpoRendimentos').append(itens);
						});
						
						document.getElementById('clientesSolicitacoes').remove();
						$('#graficoClientes').append('<canvas id="clientesSolicitacoes" style="height:35vh; width:30vw"></canvas>');

						var labelNomes=[], labelTemposNomes=[], labelQuantidades=[], labelTempos=[];
						
						data.clientes.forEach((cliente, i) => {

						    if (cliente.qtdHoras && cliente.qtdHoras !== 0) {
						        labelTemposNomes[i] =
						            `${cliente.nomeCliente} (${cliente.qtdHoras})`;
						        labelTempos[i] = cliente.qtdHoras;
						    }

						    labelNomes[i] =
						        `${cliente.nomeCliente} (${cliente.qtdFinalizados})`;
						    labelQuantidades[i] = cliente.qtdFinalizados;
						});


						const ctx5 = document.getElementById('clientesSolicitacoes');
						new Chart(ctx5, {
							type: 'line',
							data: {
								labels: labelNomes,
								datasets: [{
									label: 'Finalizados por Clientes: ',
									data: labelQuantidades,
									backgroundColor: [
										'rgba(255, 0, 0, 0.5)',
										'rgba(255, 135, 0, 0.5)',
										'rgba(6, 26, 209, 0.5)',
										'rgba(12, 218, 205, 0.5)',
										'rgba(54, 162, 235, 0.2)',
										'rgba(153, 102, 255, 0.2)',
										'rgba(201, 203, 207, 0.2)'
									],
									borderColor: [
										'rgb(255, 0, 0, 0.5)',
										'rgb(255, 135, 0, 0.5)',
										'rgb(6, 26, 209, 0.5)',
										'rgb(12, 218, 205, 0.5)',
										'rgb(54, 162, 235, 0.2)',
										'rgb(153, 102, 255, 0.2)',
										'rgb(201, 203, 207, 0.2)'
									],
									borderWidth: 1,
									 tension: 0.2
								}]
							},
							options: { responsive: true, }
						});
						
						document.getElementById('minutosSolicitacoes').remove();
						$('#graficoTempo').append('<canvas id="minutosSolicitacoes" style="height:35vh; width:30vw"></canvas>');
						
						const ctx = document.getElementById('minutosSolicitacoes');
						new Chart(ctx, {
						type: 'doughnut',
						data: {
							labels: labelTemposNomes,
							datasets: [{
								label: 'Finalizados por Cliente: ',
								data: labelTempos,
								backgroundColor: [
									'rgba(255, 0, 0, 0.5)',
									'rgba(255, 135, 0, 0.5)',
									'rgba(6, 26, 209, 0.5)',
									'rgba(12, 218, 205, 0.5)',
									'rgba(54, 162, 235, 0.2)',
									'rgba(153, 102, 255, 0.2)',
									'rgba(40, 100, 100, 0.2)',
									'rgba(15, 200, 200, 0.2)',
									'rgba(60, 12, 12, 0.2)',
									'rgba(250, 10, 220, 0.2)',
									'rgba(255, 5, 5, 0.2)'
								],
								borderColor: [
									'rgb(255, 0, 0, 0.5)',
									'rgb(255, 135, 0, 0.5)',
									'rgb(6, 26, 209, 0.5)',
									'rgb(12, 218, 205, 0.5)',
									'rgb(54, 162, 235, 0.2)',
									'rgb(153, 102, 255, 0.2)',
									'rgb(40, 100, 100, 0.2)',
									'rgba(15, 200, 200, 0.2)',
									'rgba(60, 12, 12, 0.2)',
									'rgba(250, 10, 220, 0.2)',
									'rgba(255, 5, 5, 0.2)'
								],
								borderWidth: 1,
								 tension: 0.2
							}]
						},
						options: { responsive: true, }
					});
						
					},
					statusCode: {
				   	 	500: function() { alert('Erro! Contate o desenvolvedor!'); },
				    	401: function() { alert('Realize login novamente!'); }
					}
				});
				
			}else{
				alert("Selecione (data de inicio e data de término)");
			}
			
			const formatarMoedaBR = (valor) => {
			    return new Intl.NumberFormat('pt-BR', {
			        style: 'currency',
			        currency: 'BRL',
			        minimumFractionDigits: 2,
			        maximumFractionDigits: 2
			    }).format(valor);
			};

		}
		
		function minutosParaHorasTexto(minutos){
			if(minutos<=60){
				return`${minutos} minutos`;
			}else{
				const horas = Math.floor(minutos / 60), min = Math.round((minutos / 60 - horas ) * 60 );
				return`${horas} horas ${min} minutos`;
			}
		}
		
		function minutosParaHorasNumero(minutos){
			if(minutos<=60){
				return minutos;
			}else{
				const horas = Math.floor(minutos / 60), min = Math.round((minutos / 60 - horas ) * 60 );
				return horas+"."+min;
			}
		}
		
	</script>
	<script>
		function preencheHoje(){
			var data = new Date();
			var hoje, mes, dia;
			
			if(data.getMonth()+1 > 12){ mes=1; }
			else if(data.getMonth()+1 < 10){ mes = "0"+(data.getMonth()+1); }
			else{ mes = data.getMonth()+1; }
			
			if(data.getDate() < 10){ dia = "0"+data.getDate(); }
			else{ dia = data.getDate(); }
			var hoje = data.getFullYear()+'-'+mes+'-'+dia;
			
			$('#dataInicio').val(hoje);
			$('#dataFim').val(hoje);
		}
		
		function preencheDias(dias){
			var inicio, fim, mes, diaInicio, diaFim;
			var data = new Date();
			
			if(data.getDate() < 10){ diaFim = "0"+data.getDate(); }
			else{ diaFim = data.getDate(); }
			
			if(data.getMonth()+1 > 12){ mes=1; }
			else if(data.getMonth()+1 < 10){ mes = "0"+(data.getMonth()+1); }
			else{ mes = data.getMonth()+1; }
			var fim = data.getFullYear()+'-'+mes+'-'+diaFim;

			data.setDate(data.getDate() - dias);
			
			if(data.getDate() < 10){ diaInicio = "0"+data.getDate(); }
			else{ diaInicio = data.getDate(); }
			
			if(data.getMonth()+1 > 12){ mes=1; }
			else if(data.getMonth()+1 < 10){ mes = "0"+(data.getMonth()+1); }
			else{ mes = data.getMonth()+1; }
			var inicio = data.getFullYear()+'-'+mes+'-'+diaInicio;
			
			$('#dataInicio').val(inicio);
			$('#dataFim').val(fim);
		}
		
	</script>
</body>
</html>